import React, { useState, useEffect, useMemo, useRef } from 'react';
import { 
  Trophy, 
  Lightbulb, 
  CheckCircle, 
  XCircle, 
  Clock, 
  Award, 
  RefreshCcw, 
  BookOpen, 
  Share2,
  ChevronRight,
  AlertCircle
} from 'lucide-react';

/**
 * GOOGLE SITES RECRUITMENT QUIZ
 * -----------------------------
 * A gamified experience to train and recruit students for web migration.
 */

// --- CELEBRATION COMPONENT ---
const FallingBalls = () => {
  const canvasRef = useRef(null);

  useEffect(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    let animationFrameId;
    let balls = [];

    const colors = ['#EF4444', '#3B82F6', '#10B981', '#F59E0B', '#8B5CF6', '#EC4899'];

    // Initialize balls
    const createBalls = () => {
      for (let i = 0; i < 50; i++) {
        balls.push({
          x: Math.random() * canvas.width,
          y: -Math.random() * canvas.height, // Start above screen
          radius: Math.random() * 10 + 5,
          color: colors[Math.floor(Math.random() * colors.length)],
          velocity: {
            x: (Math.random() - 0.5) * 4,
            y: Math.random() * 5 + 5 // Falling speed
          }
        });
      }
    };

    const resizeCanvas = () => {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    };

    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    createBalls();

    const render = () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      balls.forEach(ball => {
        ball.x += ball.velocity.x;
        ball.y += ball.velocity.y;
        
        // Gravity effect
        ball.velocity.y += 0.2;

        ctx.beginPath();
        ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
        ctx.fillStyle = ball.color;
        ctx.fill();
        ctx.closePath();
      });

      animationFrameId = requestAnimationFrame(render);
    };

    render();

    return () => {
      window.removeEventListener('resize', resizeCanvas);
      cancelAnimationFrame(animationFrameId);
    };
  }, []);

  return (
    <canvas 
      ref={canvasRef} 
      className="fixed inset-0 pointer-events-none z-[100]"
    />
  );
};

// --- DATASET ---
// A mix of Basic Knowledge (Technical) and Scenario (Best Practice) questions.
const QUESTION_BANK = [
  // --- BASIC KNOWLEDGE (Selection of 60-style questions) ---
  {
    id: 1,
    type: 'basic',
    question: "What is the primary way to add content (Text, Images, Drive files) to a Google Site?",
    options: ["File > Open", "The 'Insert' panel on the right", "Right-click anywhere", "Settings menu"],
    correct: 1,
    hint: "Look for the sidebar menu when in the editor.",
    explanation: "The 'Insert' panel is your main toolbox for adding text boxes, images, layouts, and Drive components."
  },
  {
    id: 2,
    type: 'basic',
    question: "How do you preview what your site looks like on a mobile device before publishing?",
    options: ["Send the link to your phone", "You can't until you publish", "Click the 'Preview' button (laptop icon) in the top bar", "Resize your browser window"],
    correct: 2,
    hint: "Look for an icon that looks like a laptop and phone combined.",
    explanation: "The Preview mode allows you to switch between Desktop, Tablet, and Mobile views instantly."
  },
  {
    id: 3,
    type: 'basic',
    question: "Which feature allows multiple students to work on the site at the same time?",
    options: ["Share with others (Add editors)", "Emailing screenshots", "Only one person can edit at a time", "Publishing settings"],
    correct: 0,
    hint: "It works just like Google Docs collaboration.",
    explanation: "By adding students as 'Editors' via the Share button, real-time collaboration is enabled."
  },
  {
    id: 4,
    type: 'basic',
    question: "Where do you change the main color scheme and font style of your site?",
    options: ["In every text box manually", "The 'Themes' tab", "The 'Pages' tab", "Site Settings"],
    correct: 1,
    hint: "It's one of the three main tabs in the sidebar.",
    explanation: "The Themes tab controls global styles, including color palettes and font families."
  },
  {
    id: 5,
    type: 'basic',
    question: "How do you create a drop-down menu in the navigation bar?",
    options: ["Drag one page onto another in the 'Pages' tab", "Use a special code", "Create a 'Folder' option", "You can only have a flat menu"],
    correct: 0,
    hint: "Think about nesting pages.",
    explanation: "Dragging a page on top of another in the Pages tab creates a sub-page, forming a drop-down menu."
  },
  {
    id: 6,
    type: 'basic',
    question: "What is the purpose of the 'Announcement Banner'?",
    options: ["To show ads", "To display a prominent message above the header on all pages", "To email students", "To change the footer"],
    correct: 1,
    hint: "It appears at the very top of the browser window.",
    explanation: "Announcement banners are used for important alerts (e.g., 'School closed today') appearing on every page."
  },
  {
    id: 7,
    type: 'basic',
    question: "If you make a mistake while editing, how can you fix it quickly?",
    options: ["Delete the site", "Refresh the page", "Use the 'Undo' arrow in the top bar", "There is no undo"],
    correct: 2,
    hint: "The icon looks like a curved arrow pointing back.",
    explanation: "Google Sites has robust Undo/Redo functionality in the top toolbar."
  },
  {
    id: 8,
    type: 'basic',
    question: "What is the difference between 'Draft' and 'Published' status?",
    options: ["No difference", "Draft is visible to everyone, Published is private", "Draft is your work-in-progress; Published is the live version visitors see", "Drafts are deleted after 24 hours"],
    correct: 2,
    hint: "You must hit the blue button to make changes live.",
    explanation: "Changes are saved automatically to the Draft, but the world only sees them after you click Publish."
  },
  {
    id: 9,
    type: 'basic',
    question: "How can you add a YouTube video to your page?",
    options: ["Download it and upload the file", "Use the 'YouTube' button in the Insert menu", "You can't use videos", "Take a screenshot of the video"],
    correct: 1,
    hint: "Google owns YouTube, so the integration is seamless.",
    explanation: "The Insert menu has a dedicated YouTube widget that lets you search or paste a URL."
  },
  {
    id: 10,
    type: 'basic',
    question: "Which image format is NOT recommended because it doesn't scale well?",
    options: ["A high-quality JPEG", "A PNG for logos", "A tiny thumbnail stretched to full width", "A GIF"],
    correct: 2,
    hint: "Think about pixelation.",
    explanation: "Stretching small images makes them blurry. Always use high-resolution images for headers."
  },
  {
    id: 11,
    type: 'basic',
    question: "What tool allows visitors to navigate to different sections of a long page quickly?",
    options: ["Table of Contents", "Image Carousel", "Divider", "Spacer"],
    correct: 0,
    hint: "It automatically generates links based on your Headings.",
    explanation: "The Table of Contents gadget automatically links to H1 and H2 texts on the page."
  },
  {
    id: 12,
    type: 'basic',
    question: "How do you add a logo to the top left of the navigation bar?",
    options: ["Insert an image box", "Hover over the site name and click 'Add Logo'", "It is not possible", "Use the Themes tab"],
    correct: 1,
    hint: "Hover your mouse near the site title.",
    explanation: "Hovering over the site name reveals the 'Add Logo' settings for the header."
  },
  {
    id: 13,
    type: 'basic',
    question: "What is 'Alt Text' on an image used for?",
    options: ["SEO and Accessibility for screen readers", "To change the image color", "To add a caption below the image", "To link the image"],
    correct: 0,
    hint: "It helps blind users understand the image.",
    explanation: "Alt text describes images for visually impaired users and helps search engines understand content."
  },
  {
    id: 14,
    type: 'basic',
    question: "Can you restore a previous version of your site if you mess up badly?",
    options: ["No, updates are permanent", "Yes, using 'Version History'", "Only if you pay", "Only if you downloaded a backup"],
    correct: 1,
    hint: "It's in the three-dot menu.",
    explanation: "Version History allows you to view and restore previous states of the site."
  },
  {
    id: 15,
    type: 'basic',
    question: "What does the 'Collapsible Group' feature do?",
    options: ["Deletes old text", "Hides text behind a clickable heading to save space", "Groups images together", "Collapses the entire website"],
    correct: 1,
    hint: "Great for FAQs.",
    explanation: "It creates an accordion-style text box that expands when clicked."
  },

  // --- SCENARIO / CONTENT STRATEGY (15 questions) ---
  {
    id: 16,
    type: 'scenario',
    question: "SCENARIO: The Principal wants a weekly 'School News' update. What is the best way to display this so it is easy to read on mobile?",
    options: ["Upload a PDF of the newsletter", "Take a picture of the printed newsletter", "Type the text directly into the site using text boxes and headings", "Upload a Word Doc link"],
    correct: 2,
    hint: "PDFs are hard to read on small phone screens.",
    explanation: "Direct text flows and resizes for mobile screens (responsive design), whereas PDFs require pinching and zooming."
  },
  {
    id: 17,
    type: 'scenario',
    question: "SCENARIO: You need to showcase 50 photos from Sports Day. What is the cleanest layout?",
    options: ["Put 50 huge images one after another", "Use the 'Image Carousel' or a Grid layout", "Create 50 different pages", "Zip them and add a download link"],
    correct: 1,
    hint: "Nobody likes scrolling forever.",
    explanation: "An Image Carousel or Grid keeps the page short and allows users to browse photos interactively."
  },
  {
    id: 18,
    type: 'scenario',
    question: "SCENARIO: The Student Council wants to collect feedback from students about the canteen food.",
    options: ["Put an email address in a text box", "Embed a Google Form", "Ask them to comment on the site", "Write a letter"],
    correct: 1,
    hint: "You want the data to go into a spreadsheet automatically.",
    explanation: "Embedding a Google Form allows for secure, organized data collection directly on the site."
  },
  {
    id: 19,
    type: 'scenario',
    question: "SCENARIO: We need to show the location of the upcoming inter-school match.",
    options: ["Type the address", "Upload a screenshot of a map", "Embed a Google Map", "Draw a map in Paint"],
    correct: 2,
    hint: "Users might want to click 'Directions'.",
    explanation: "An embedded Google Map is interactive, allowing users to zoom and get directions."
  },
  {
    id: 20,
    type: 'scenario',
    question: "SCENARIO: The Science Club wants to share their research slide deck.",
    options: ["Copy paste every slide as an image", "Embed the Google Slides presentation", "Write it all out again", "Link to Wikipedia"],
    correct: 1,
    hint: "Save time, don't duplicate work.",
    explanation: "Embedding the Slide deck allows users to click through slides without leaving the webpage."
  },
  {
    id: 21,
    type: 'scenario',
    question: "SCENARIO: You want to introduce the 5 main committee members with their photos and roles.",
    options: ["Use the 'Team' Content Block (Image + Text)", "One big photo of everyone", "Just list their names", "Make a video"],
    correct: 0,
    hint: "Check the 'Layouts' section in the Insert tab.",
    explanation: "The pre-made Content Blocks are designed perfectly for profiles (Image + Heading + Description)."
  },
  {
    id: 22,
    type: 'scenario',
    question: "SCENARIO: A teacher has a long PDF syllabus that MUST be preserved exactly as is (with signatures).",
    options: ["Retype it", "Embed the PDF from Drive so it previews on the page", "Link to a text file", "Take a photo"],
    correct: 1,
    hint: "Sometimes format matters more than mobile responsiveness.",
    explanation: "Embedding the file from Drive allows the user to scroll through the document within the site window."
  },
  {
    id: 23,
    type: 'scenario',
    question: "SCENARIO: You are creating a 'Help' section with 20 questions. How do you prevent the page from looking cluttered?",
    options: ["Use tiny font", "Use 'Collapsible Group' text for each Question/Answer", "Put them all in one paragraph", "Delete 10 questions"],
    correct: 1,
    hint: "Let the user choose what they want to read.",
    explanation: "Collapsible text keeps the page clean and lets users expand only the answers they need."
  },
  {
    id: 24,
    type: 'scenario',
    question: "SCENARIO: You want to add a 'Register Now' button that stands out.",
    options: ["Type 'Register' in bold", "Use the 'Button' component with a contrasting color", "Upload an image of a button", "Put a link in the footer"],
    correct: 1,
    hint: "Google Sites has a specific component for this.",
    explanation: "Native Buttons are accessible, responsive, and follow the site's theme automatically."
  },
  {
    id: 25,
    type: 'scenario',
    question: "SCENARIO: You want to embed a Calendar showing all school holidays.",
    options: ["Type dates in a list", "Upload an Excel file", "Embed a Google Calendar", "Use a screenshot of a calendar"],
    correct: 2,
    hint: "Updates to the calendar should show up automatically on the site.",
    explanation: "Embedding a Google Calendar ensures that if the school admin updates a date, the site updates automatically."
  },
  // --- ADDITIONAL QUESTIONS (26-45) ---
  {
    id: 26,
    type: 'basic',
    question: "How do you change the navigation menu from the 'Top' of the site to the 'Side'?",
    options: ["You cannot change it", "Settings (Gear Icon) > Navigation > Mode", "Drag the menu bar", "Themes > Menu style"],
    correct: 1,
    hint: "Check the settings gear icon.",
    explanation: "The Settings menu allows you to toggle between Top navigation and Side navigation (drawer style)."
  },
  {
    id: 27,
    type: 'basic',
    question: "What is a 'Favicon'?",
    options: ["The main logo on the page", "The small icon that appears in the browser tab next to the site title", "A favorite contact", "A type of font"],
    correct: 1,
    hint: "It helps users identify your tab when they have many open.",
    explanation: "A Favicon is the small icon shown in browser tabs, bookmarks, and history."
  },
  {
    id: 28,
    type: 'basic',
    question: "Which Google tool allows you to track statistics like how many people visit your site?",
    options: ["Google Analytics", "Google Tracker", "Site Counter", "Visitor Log"],
    correct: 0,
    hint: "It requires a Measurement ID.",
    explanation: "Google Analytics integrates with Sites to provide detailed data on visitor numbers and behavior."
  },
  {
    id: 29,
    type: 'basic',
    question: "Can you use a custom domain (like www.myschool.com) with Google Sites?",
    options: ["No, it must be sites.google.com", "Yes, configured in Settings > Custom Domains", "Only for personal accounts", "Yes, but you have to pay Google Sites"],
    correct: 1,
    hint: "It makes the URL look professional.",
    explanation: "You can map a custom web address (URL) to your Google Site via the Settings panel."
  },
  {
    id: 30,
    type: 'basic',
    question: "How do you duplicate an entire site to use it as a template for next year?",
    options: ["Copy paste every page", "Click the three dots (More) > Duplicate site", "File > Save As", "You cannot duplicate sites"],
    correct: 1,
    hint: "Look in the 'More' menu near the Publish button.",
    explanation: "The 'Duplicate site' feature creates a full copy of the site structure and content."
  },
  {
    id: 31,
    type: 'basic',
    question: "If you edit the Footer of your site, where does the change appear?",
    options: ["Only on the Home page", "Only on the current page", "On every page of the site", "Nowhere"],
    correct: 2,
    hint: "Footers are global elements.",
    explanation: "The Footer is a global element that remains consistent across all pages of your site."
  },
  {
    id: 32,
    type: 'basic',
    question: "Which of the following is NOT a standard Header type in Google Sites?",
    options: ["Cover", "Large Banner", "Title Only", "Video Background"],
    correct: 3,
    hint: "You can put a video in the background, but the type is usually called something else.",
    explanation: "The standard types are Cover, Large Banner, Banner, and Title Only. While banners can have video backgrounds, 'Video Background' is not a header type name."
  },
  {
    id: 33,
    type: 'basic',
    question: "How do you add a specific background image or color to just one Section of a page?",
    options: ["Themes tab", "Click the palette icon on the left of the section", "Right click the background", "Insert > Image"],
    correct: 1,
    hint: "Look for the floating toolbar on the left of the active section.",
    explanation: "The Section Colors (palette) icon allows you to set styles like 'Regular', 'Emphasis 1', 'Emphasis 2', or 'Image' for that specific block."
  },
  {
    id: 34,
    type: 'basic',
    question: "Can you hide a specific page from the navigation menu but keep it accessible via a link?",
    options: ["No, all pages must be in the menu", "Yes, click three dots on the page in Pages tab > Hide from navigation", "Yes, delete the page", "Yes, make it a sub-page"],
    correct: 1,
    hint: "Useful for 'Thank You' pages or internal links.",
    explanation: "'Hide from navigation' removes the link from the menu bar but keeps the page live and accessible if you share the direct URL."
  },
  {
    id: 35,
    type: 'basic',
    question: "What happens if you paste a URL (link) directly into the page editor?",
    options: ["Nothing", "It just shows the text", "It attempts to create a smart preview card or embed", "It crashes the site"],
    correct: 2,
    hint: "Google tries to be smart about links.",
    explanation: "Pasting a URL triggers a 'Smart Chip' or preview card option, allowing you to display a visual bookmark of the link."
  },
  {
    id: 36,
    type: 'scenario',
    question: "SCENARIO: A teacher wants a 'Student of the Month' section that stands out visually from the rest of the text.",
    options: ["Make the font size 50", "Use the Section Background 'Emphasis' style", "Use all caps", "Put it in the footer"],
    correct: 1,
    hint: "Use color to break up the page.",
    explanation: "Using 'Emphasis 1' or 'Emphasis 2' adds a background color to the section, creating visual separation and hierarchy."
  },
  {
    id: 37,
    type: 'scenario',
    question: "SCENARIO: You need to share a folder of 20 PDF worksheets. Instead of linking each one manually, what is faster?",
    options: ["Embed the Drive Folder directly", "Take screenshots of the files", "List them in a text box", "Email them"],
    correct: 0,
    hint: "If you add a file to the folder in Drive, the site updates automatically.",
    explanation: "Embedding a Drive Folder displays a list view of all files inside, automatically updating when you add files to the folder in Drive."
  },
  {
    id: 38,
    type: 'scenario',
    question: "SCENARIO: The Principal wants to ensure the school logo appears on every slide of the embedded presentation.",
    options: ["Edit the Master Slide in Google Slides", "Add an image in Google Sites on top of the slides", "It's not possible", "Add it to the Site Header"],
    correct: 0,
    hint: "Fix the source, not the site.",
    explanation: "Changes to the content of an embedded file must be made in the source file (Google Slides), not in the website builder."
  },
  {
    id: 39,
    type: 'scenario',
    question: "SCENARIO: You want to create a button that automatically opens an email draft to the office when clicked.",
    options: ["Link to 'www.gmail.com'", "Type 'mailto:office@school.edu' in the link field", "Use a form", "Just write the email address"],
    correct: 1,
    hint: "The 'mailto:' protocol is the web standard for this.",
    explanation: "Entering 'mailto:address@example.com' creates a link that opens the user's default email client."
  },
  {
    id: 40,
    type: 'scenario',
    question: "SCENARIO: A parent complains they can't see the embedded Google Doc on the site (it says 'Access Denied'). What is the cause?",
    options: ["The site is down", "The Doc's share settings in Drive are restricted", "They don't have a Google account", "The internet is slow"],
    correct: 1,
    hint: "Publishing the site doesn't automatically publish the private files on it.",
    explanation: "You must ensure embedded Drive files are shared as 'Anyone with the link can view' so visitors can see them."
  },
  {
    id: 41,
    type: 'scenario',
    question: "SCENARIO: You need to create an 'Intranet' portal containing sensitive info only for teachers.",
    options: ["Password protect the page", "Create a separate Site and share it only with the 'Teachers' group", "Hide it from navigation", "Put it at the bottom of the page"],
    correct: 1,
    hint: "Hiding a page is not security.",
    explanation: "The best practice for security is to create a separate site and restrict access permissions to specific users or groups."
  },
  {
    id: 42,
    type: 'scenario',
    question: "SCENARIO: You want to show a live countdown to Graduation Day.",
    options: ["Update a text box every day", "Embed a Countdown Widget using 'Embed Code'", "Use a calendar", "Post a clock image"],
    correct: 1,
    hint: "Google Sites allows you to inject HTML/Javascript snippets.",
    explanation: "The 'Embed Code' feature allows you to use third-party widgets like countdown timers on your page."
  },
  {
    id: 43,
    type: 'scenario',
    question: "SCENARIO: How do you ensure your text is readable against a busy background image in the Header?",
    options: ["Use the 'Readability adjustment' (anchor icon) feature", "Delete the image", "Make the text black", "Make the text tiny"],
    correct: 0,
    hint: "It darkens the image automatically.",
    explanation: "The readability adjustment (glitter/anchor icon) automatically lightens or darkens the image to ensure the text has enough contrast."
  },
  {
    id: 44,
    type: 'scenario',
    question: "SCENARIO: You want to display the school's live basketball scores from a spreadsheet.",
    options: ["Type them in a table", "Embed the Google Sheet or a Chart generated from it", "Take a photo of the scoreboard", "Link to ESPN"],
    correct: 1,
    hint: "Dynamic data.",
    explanation: "Embedding the Sheet or Chart ensures that as soon as the scorekeeper updates the sheet, the site updates live."
  },
  {
    id: 45,
    type: 'scenario',
    question: "SCENARIO: You are graduating and leaving the committee. How do you ensure the site isn't deleted when your account is closed?",
    options: ["It won't be deleted", "Transfer ownership to a generic school account or another editor", "Download the HTML", "Print the pages"],
    correct: 1,
    hint: "Google files are deleted if the owner's account is deleted.",
    explanation: "You must transfer ownership of the Site file in Drive to a permanent account to prevent it from being lost."
  }
];

// Motivational Phrases for wrong answers
const MOTIVATION = [
  "Not quite! Mistakes are how we learn.",
  "Keep going! You'll get it next time.",
  "Close, but review the hint!",
  "Don't give up, future webmaster!",
  "Growth mindset: You just learned something new.",
  "That was a tricky one. Try to remember the logic."
];

export default function App() {
  // --- STATE MANAGEMENT ---
  const [gameState, setGameState] = useState('menu'); // menu, playing, feedback, summary, certificate
  const [gameMode, setGameMode] = useState('standard'); // standard, challenge
  const [currentQIndex, setCurrentQIndex] = useState(0);
  const [score, setScore] = useState(0);
  const [userAnswers, setUserAnswers] = useState([]); // Store { questionId, answerIndex, isCorrect }
  const [userName, setUserName] = useState('');
  const [wrongQueue, setWrongQueue] = useState([]); // IDs of questions to retry
  const [isRetrying, setIsRetrying] = useState(false);
  const [timeLeft, setTimeLeft] = useState(600); // 10 minutes for challenge
  const [showCelebration, setShowCelebration] = useState(false);

  // Helper to get current question object
  const activeQueue = isRetrying ? wrongQueue.map(id => QUESTION_BANK.find(q => q.id === id)) : QUESTION_BANK;
  const currentQuestion = activeQueue[currentQIndex];

  // --- TIMER LOGIC (Challenge Mode) ---
  useEffect(() => {
    let timer;
    if (gameState === 'playing' && gameMode === 'challenge' && timeLeft > 0 && !showCelebration) {
      timer = setInterval(() => setTimeLeft(prev => prev - 1), 1000);
    } else if (timeLeft === 0 && gameState === 'playing' && gameMode === 'challenge') {
      finishQuiz();
    }
    return () => clearInterval(timer);
  }, [gameState, gameMode, timeLeft, showCelebration]);

  // --- ACTIONS ---

  const startGame = (mode) => {
    setGameMode(mode);
    setGameState('playing');
    setCurrentQIndex(0);
    setScore(0);
    setUserAnswers([]);
    setWrongQueue([]);
    setIsRetrying(false);
    setShowCelebration(false);
    setTimeLeft(mode === 'challenge' ? 600 : 0);
  };

  const handleAnswer = (optionIndex) => {
    if (showCelebration) return; // Prevent double clicks during animation

    const isCorrect = optionIndex === currentQuestion.correct;
    
    // Record answer
    const answerRecord = {
      questionId: currentQuestion.id,
      selected: optionIndex,
      isCorrect: isCorrect,
      questionText: currentQuestion.question,
      explanation: currentQuestion.explanation
    };

    setUserAnswers(prev => [...prev, answerRecord]);

    if (isCorrect) {
      setScore(prev => prev + 1);
      setShowCelebration(true); // Start celebration

      // Delay for celebration before proceeding
      setTimeout(() => {
        setShowCelebration(false);
        // In challenge mode, no feedback modal, just move on
        if (gameMode === 'challenge') {
          nextQuestion();
        } else {
          setGameState('feedback');
        }
      }, 1000); // 1 second delay
      
    } else {
      // Wrong answer - immediate feedback (no celebration)
      if (!wrongQueue.includes(currentQuestion.id)) {
        setWrongQueue(prev => [...prev, currentQuestion.id]);
      }
      setGameState('feedback');
    }
  };

  const nextQuestion = () => {
    if (currentQIndex < activeQueue.length - 1) {
      setCurrentQIndex(prev => prev + 1);
      setGameState('playing');
    } else {
      finishQuiz();
    }
  };

  const finishQuiz = () => {
    setGameState('summary');
  };

  const startRetry = () => {
    setIsRetrying(true);
    setCurrentQIndex(0);
    setGameState('playing');
  };

  const generateCertificate = () => {
    if (!userName.trim()) return alert("Please enter your name.");
    setGameState('certificate');
  };

  // --- RENDER HELPERS ---

  const getRandomMotivation = () => MOTIVATION[Math.floor(Math.random() * MOTIVATION.length)];

  // --- VIEWS ---

  const renderMenu = () => (
    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-50 p-6 text-center">
      <div className="bg-white p-8 rounded-2xl shadow-xl max-w-2xl w-full border-t-8 border-blue-500">
        <div className="mb-6 flex justify-center">
          <div className="bg-blue-100 p-4 rounded-full">
            <BookOpen className="w-12 h-12 text-blue-600" />
          </div>
        </div>
        <h1 className="text-4xl font-bold text-gray-800 mb-2">Google Sites Builder Certification</h1>
        <p className="text-gray-600 mb-8 text-lg">
          Join the School Web Migration Team! Prove your skills in basic editing and content strategy.
        </p>

        <div className="grid md:grid-cols-2 gap-4">
          <button 
            onClick={() => startGame('standard')}
            className="group relative p-6 bg-white border-2 border-blue-100 rounded-xl hover:border-blue-500 transition-all hover:shadow-lg text-left"
          >
            <div className="flex items-center mb-2">
              <Lightbulb className="w-6 h-6 text-yellow-500 mr-2" />
              <h3 className="font-bold text-lg text-gray-800">Training Mode</h3>
            </div>
            <p className="text-sm text-gray-500">Hints enabled. Immediate feedback. Adaptive retry for wrong answers.</p>
          </button>

          <button 
            onClick={() => startGame('challenge')}
            className="group relative p-6 bg-white border-2 border-red-100 rounded-xl hover:border-red-500 transition-all hover:shadow-lg text-left"
          >
            <div className="flex items-center mb-2">
              <Clock className="w-6 h-6 text-red-500 mr-2" />
              <h3 className="font-bold text-lg text-gray-800">Challenge Mode</h3>
            </div>
            <p className="text-sm text-gray-500">10 Minute Timer. No Hints. Pure skill testing.</p>
          </button>
        </div>
      </div>
    </div>
  );

  const renderPlaying = () => {
    if (!currentQuestion) return <div>Loading...</div>;

    return (
      <div className="min-h-screen bg-gray-50 p-4 md:p-8 flex flex-col items-center relative">
        {/* Celebration Overlay */}
        {showCelebration && <FallingBalls />}

        {/* Header Bar */}
        <div className="w-full max-w-3xl flex justify-between items-center mb-6 bg-white p-4 rounded-lg shadow-sm z-10">
          <div className="flex items-center space-x-2">
            <span className={`px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wide ${currentQuestion.type === 'scenario' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}`}>
              {currentQuestion.type === 'scenario' ? 'Scenario' : 'Basic Skill'}
            </span>
            <span className="text-gray-500 font-medium">Q{currentQIndex + 1} of {activeQueue.length}</span>
          </div>
          {gameMode === 'challenge' && (
            <div className={`font-mono text-xl font-bold ${timeLeft < 60 ? 'text-red-500' : 'text-gray-700'}`}>
              {Math.floor(timeLeft / 60)}:{(timeLeft % 60).toString().padStart(2, '0')}
            </div>
          )}
        </div>

        {/* Question Card */}
        <div className="w-full max-w-3xl bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-100 z-10">
          <div className="p-8">
            <h2 className="text-2xl font-bold text-gray-800 mb-6 leading-relaxed">
              {currentQuestion.question}
            </h2>

            <div className="space-y-3">
              {currentQuestion.options.map((option, idx) => (
                <button
                  key={idx}
                  onClick={() => handleAnswer(idx)}
                  disabled={showCelebration}
                  className={`w-full text-left p-4 rounded-xl border border-gray-200 transition-all flex items-center group
                    ${showCelebration && idx === currentQuestion.correct ? 'bg-green-100 border-green-500' : 'hover:bg-blue-50 hover:border-blue-300'}
                  `}
                >
                  <div className={`w-8 h-8 rounded-full flex items-center justify-center mr-4 font-bold text-sm
                    ${showCelebration && idx === currentQuestion.correct ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-500 group-hover:bg-blue-200 group-hover:text-blue-700'}
                  `}>
                    {String.fromCharCode(65 + idx)}
                  </div>
                  <span className="text-gray-700 group-hover:text-gray-900 font-medium">{option}</span>
                </button>
              ))}
            </div>
          </div>

          {/* Hint Section (Standard Mode Only) */}
          {gameMode === 'standard' && (
            <div className="bg-gray-50 p-4 border-t border-gray-100">
              <details className="group cursor-pointer">
                <summary className="flex items-center text-sm font-medium text-gray-500 hover:text-blue-600 list-none">
                  <Lightbulb className="w-4 h-4 mr-2" />
                  Need a hint?
                </summary>
                <div className="mt-2 text-sm text-gray-600 italic pl-6 bg-yellow-50 p-2 rounded border border-yellow-100">
                  {currentQuestion.hint}
                </div>
              </details>
            </div>
          )}
        </div>
      </div>
    );
  };

  const renderFeedback = () => {
    const lastAnswer = userAnswers[userAnswers.length - 1];
    const isCorrect = lastAnswer.isCorrect;

    return (
      <div className="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50 animate-in fade-in duration-200">
        <div className="bg-white rounded-2xl shadow-2xl max-w-lg w-full overflow-hidden transform scale-100">
          <div className={`p-6 ${isCorrect ? 'bg-green-50' : 'bg-red-50'} flex flex-col items-center text-center`}>
            {isCorrect ? (
              <CheckCircle className="w-16 h-16 text-green-500 mb-4" />
            ) : (
              <XCircle className="w-16 h-16 text-red-500 mb-4" />
            )}
            
            <h2 className={`text-2xl font-bold mb-2 ${isCorrect ? 'text-green-800' : 'text-red-800'}`}>
              {isCorrect ? "Excellent!" : "Not Quite."}
            </h2>
            
            {!isCorrect && (
              <p className="text-red-600 font-medium italic mb-4">"{getRandomMotivation()}"</p>
            )}
            
            <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-100 text-left w-full">
              <p className="text-xs text-gray-400 uppercase font-bold mb-1">Expert Insight</p>
              <p className="text-gray-700 leading-relaxed">{lastAnswer.explanation}</p>
            </div>
          </div>
          
          <div className="p-4 bg-gray-50 flex justify-end">
            <button 
              onClick={nextQuestion}
              className="px-6 py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors flex items-center"
            >
              Next Question <ChevronRight className="w-4 h-4 ml-2" />
            </button>
          </div>
        </div>
      </div>
    );
  };

  const renderSummary = () => {
    const totalQ = isRetrying ? wrongQueue.length : QUESTION_BANK.length;
    // Calculate display score differently if retrying
    const displayScore = isRetrying ? "Review Complete" : `${score} / ${QUESTION_BANK.length}`;
    const percentage = Math.round((score / QUESTION_BANK.length) * 100);

    return (
      <div className="min-h-screen bg-gray-50 p-6 flex items-center justify-center">
        <div className="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-8 text-center">
          <Trophy className="w-20 h-20 text-yellow-400 mx-auto mb-6" />
          
          <h2 className="text-3xl font-bold text-gray-800 mb-2">Assessment Complete!</h2>
          <p className="text-gray-500 mb-8">Here is how you performed.</p>

          <div className="grid grid-cols-2 gap-4 mb-8">
            <div className="bg-blue-50 p-4 rounded-xl">
              <div className="text-3xl font-bold text-blue-600">{score}</div>
              <div className="text-sm text-blue-400 font-medium">Correct Answers</div>
            </div>
            <div className="bg-purple-50 p-4 rounded-xl">
              <div className="text-3xl font-bold text-purple-600">{percentage}%</div>
              <div className="text-sm text-purple-400 font-medium">Accuracy</div>
            </div>
          </div>

          {/* Adaptive Learning Trigger */}
          {wrongQueue.length > 0 && !isRetrying ? (
            <div className="mb-8 bg-orange-50 border border-orange-200 p-6 rounded-xl text-left">
              <div className="flex items-start">
                <AlertCircle className="w-6 h-6 text-orange-500 mr-3 flex-shrink-0 mt-1" />
                <div>
                  <h3 className="font-bold text-orange-800 text-lg">Knowledge Gaps Detected</h3>
                  <p className="text-orange-700 mb-4">
                    You missed {wrongQueue.length} questions. To join the team, we need to master these concepts.
                  </p>
                  <button 
                    onClick={startRetry}
                    className="w-full py-3 bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-bold transition-colors flex items-center justify-center shadow-md"
                  >
                    <RefreshCcw className="w-5 h-5 mr-2" />
                    Review {wrongQueue.length} Wrong Answers
                  </button>
                </div>
              </div>
            </div>
          ) : (
            <div className="mb-8">
              <p className="text-green-600 font-medium text-lg">
                {isRetrying ? "Great job reviewing your mistakes!" : "Perfect Score! You are a Google Sites Wizard."}
              </p>
            </div>
          )}

          <div className="border-t border-gray-100 pt-8">
             <h3 className="text-lg font-bold text-gray-700 mb-4">Ready for your Badge?</h3>
             <input
                type="text"
                placeholder="Enter your Full Name"
                value={userName}
                onChange={(e) => setUserName(e.target.value)}
                className="w-full p-4 border-2 border-gray-200 rounded-lg text-lg mb-4 focus:border-blue-500 focus:outline-none"
             />
             <button 
               onClick={generateCertificate}
               className="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg font-bold text-xl hover:shadow-lg transition-all"
             >
               Generate Certificate
             </button>
          </div>
        </div>
      </div>
    );
  };

  const renderCertificate = () => (
    <div className="min-h-screen bg-gray-800 p-4 flex flex-col items-center justify-center overflow-auto">
      <div className="text-white mb-4 text-center">
        <p className="mb-2 font-bold animate-pulse">ðŸ‘‡ Screenshot this and share in the Telegram Group! ðŸ‘‡</p>
      </div>
      
      {/* Certificate Area */}
      <div className="bg-white p-10 rounded-lg shadow-2xl max-w-4xl w-full border-8 border-double border-blue-900 text-center relative overflow-hidden">
        {/* Background Pattern */}
        <div className="absolute top-0 left-0 w-full h-full opacity-5 pointer-events-none">
          <div className="w-full h-full" style={{backgroundImage: 'radial-gradient(#4F46E5 2px, transparent 2px)', backgroundSize: '30px 30px'}}></div>
        </div>

        <Award className="w-24 h-24 text-blue-600 mx-auto mb-6" />
        
        <h1 className="text-5xl font-serif text-gray-900 mb-2 uppercase tracking-wider">Certificate</h1>
        <h2 className="text-2xl font-serif text-gray-500 mb-8 uppercase tracking-widest">of Competency</h2>

        <p className="text-lg text-gray-600 italic mb-4">This certifies that</p>
        
        <div className="text-4xl font-bold text-blue-800 mb-4 border-b-2 border-gray-300 inline-block px-12 pb-2">
          {userName}
        </div>

        <p className="text-lg text-gray-600 mb-8 mt-4">
          Has successfully demonstrated proficiency in <br/>
          <strong>Google Sites Construction & Content Strategy</strong>
        </p>

        <div className="grid grid-cols-2 gap-8 max-w-md mx-auto mb-12">
          <div className="text-center p-4 bg-gray-50 rounded border border-gray-200">
            <div className="text-xs text-gray-500 uppercase">Score</div>
            <div className="text-2xl font-bold text-blue-600">{score} / {QUESTION_BANK.length}</div>
          </div>
          <div className="text-center p-4 bg-gray-50 rounded border border-gray-200">
            <div className="text-xs text-gray-500 uppercase">Date</div>
            <div className="text-2xl font-bold text-gray-700">{new Date().toLocaleDateString()}</div>
          </div>
        </div>

        <div className="flex flex-col items-center mt-8 px-8">
          <img 
            src="https://tienping.github.io/public_resources/images/signature.png" 
            alt="Authorized Signature" 
            className="h-20 mb-[-10px] relative z-10"
          />
          <div className="w-64 h-px bg-gray-300 mb-3"></div>
          
          <div className="flex items-center text-gray-400 mb-1">
            <Award className="w-5 h-5 mr-2" />
            <span className="font-bold text-sm tracking-widest">TP_Quizbot</span>
          </div>
          <p className="text-[10px] font-mono text-gray-400 uppercase tracking-widest">
            Generated by TP_Quizbot â€¢ Official Certification
          </p>
        </div>
      </div>

      <button 
        onClick={() => setGameState('menu')}
        className="mt-8 text-white underline hover:text-blue-300"
      >
        Start New Quiz
      </button>
    </div>
  );

  return (
    <div className="font-sans text-gray-900">
      {gameState === 'menu' && renderMenu()}
      {gameState === 'playing' && renderPlaying()}
      {gameState === 'feedback' && renderFeedback()}
      {gameState === 'summary' && renderSummary()}
      {gameState === 'certificate' && renderCertificate()}
    </div>
  );
}
